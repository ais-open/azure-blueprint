{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "environmentName": {
            "type": "string",
            "defaultValue": "AzureUSGovernment"
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "The name of the Administrator of the new VMs and Domain"
            }
        },
        "keyVaultName": {
            "type": "string"
        },
        "keyVaultResourceGroupName": {
            "type": "string"
        },
        "configureSQLAO": {
          "type": "string",
          "defaultValue": "yes",
          "allowedValues": [
            "yes",
            "no"
          ]
        },
        "certData": {
          "type": "string",
          "metadata": {
            "description": "Cert 64bit encoded .pfx file for SSL"
          }
        },
        "certPassword": {
          "type": "securestring",
          "metadata": {
            "description": "Cert 64bit encoded .pfx file for SSL"
          }
        },
        "scheduleJobGuid": {
            "type": "string",
            "metadata": {
                "description": "The GUID for the runbook job to be started."
            }
        },
        "omsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "Assign a name for the Log Analytic Workspace Name"
            }
        },
        "omsAutomationAccountName": {
            "type": "string",
            "metadata": {
                "description": "Assign a name for the Log Analytic Workspace Name"
            }
        },
        "recoveryServicesVaultName": {
            "type": "string",
            "metadata": {
                "desscription": "Name of the RecoveryServices Vault to store VM backups"
            },
            "defaultValue": "AZ-RCV-01"
        },
        "backupPolicy": {
            "type": "string",
            "defaultValue": "CustomPolicy",
            "metadata": {
                "description": "Azure Backup policy to apply to VMs"
            }
        },
        "backupScheduleRunTimes": {
            "type": "array",
            "defaultValue": ["2017-05-09T23:00:00"],
            "metadata": {
                "description": "Times in day when backup should be triggered. e.g. 01:00, 13:00. This will be used in LTR too for daily, weekly, monthly and yearly backup."
            }
        },
        "backupDailyRetentionDurationCount": {
            "type": "int",
            "defaultValue": 30,
            "metadata": {
                "description": "Number of days you want to retain the backup"
            }
        },
        "backupDaysOfTheWeek": {
            "type": "array",
            "defaultValue": ["Sunday"],
            "metadata": {
                "description": "Backup will run on array of Days like, Monday, Tuesday etc. Applies in Weekly retention only."
            }
        },
        "backupWeeklyRetentionDurationCount": {
            "type": "int",
            "defaultValue": 104,
            "metadata": {
                "description": "Number of weeks you want to retain the backup"
            }
        },
        "backupMonthlyRetentionDurationCount": {
            "type": "int",
            "defaultValue": 36,
            "metadata": {
                "description": "Number of months you want to retain the backup"
            }
        },
        "backupMonthsOfYear": {
            "type": "array",
            "defaultValue": ["January"],
            "metadata": {
                "description": "Array of Months for Yearly Retention"
            }
        },
        "backupYearlyRetentionDurationCount": {
            "type": "int",
            "defaultValue": 5,
            "metadata": {
                "description": "Number of years you want to retain the backup"
            }
        },

        "omsWorkspaceRegion": {
            "type": "string",
            "defaultValue": "USGov Virginia",
            "allowedValues": ["USGov Virginia", "East US", "West Europe", "Southeast Asia", "Australia Southeast"],
            "metadata": {
                "description": "Specify the region for your Workspace"
            }
        },
        "serviceTier": {
            "type": "string",
            "allowedValues": [
                "Free",
                "Standalone",
                "PerNode"
            ],
            "defaultValue": "PerNode",
            "metadata": {
                "description": "Service Tier: Free, Standalone, or PerNode"
            }
        },
        "dataRetention": {
            "type": "int",
            "defaultValue": 365,
            "minValue": 7,
            "maxValue": 730,
            "metadata": {
                "description": "Number of days of retention. Free plans can only have 7 days, Standalone and OMS plans include 30 days for free"
            }
        },
        "scheduleName": {
            "type": "string",
            "defaultValue": "VM-Patching-Schedule"
        },
        "exclusionPathWeb": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["c:\\Users"]
        },
        "exclusionExtensionWeb": {
            "type": "array",
            "minLength": 1,
            "defaultValue": [".txt", ".ps1"]
        },
        "exclusionProcessWeb": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["w3wp.exe", "explorer.exe"]
        },
        "exclusionPathSQL": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["c:\\Users"]
        },
        "exclusionExtensionSQL": {
            "type": "array",
            "minLength": 1,
            "defaultValue": [".txt", ".ps1"]
        },
        "exclusionProcessSQL": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["w3wp.exe", "explorer.exe"]
        },
        "exclusionPathSQLWS2012": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "c:\\Users"
        },
        "exclusionExtensionSQLWS2012": {
            "type": "string",
            "minLength": 1,
            "defaultValue": ".txt;.ps1"
        },
        "exclusionProcessSQLWS2012": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "w3wp.exe;explorer.exe"
        },
        "exclusionPathAD": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["c:\\Users"]
        },
        "exclusionExtensionAD": {
            "type": "array",
            "minLength": 1,
            "defaultValue": [".txt", ".ps1"]
        },
        "exclusionProcessAD": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["w3wp.exe", "explorer.exe"]
        },
        "exclusionPathMgt": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["c:\\Users\\adminuser"]
        },
        "exclusionExtensionMgt": {
            "type": "array",
            "minLength": 1,
            "defaultValue": [".txt"]
        },
        "exclusionProcessMgt": {
            "type": "array",
            "minLength": 1,
            "defaultValue": ["explorer.exe"]
        },
        "exclusionPathGen": {
            "type": "array",
            "defaultValue": []
        },
        "exclusionExtensionGen": {
            "type": "array",
            "defaultValue": []
        },
        "exclusionProcessGen": {
            "type": "array",
            "defaultValue": []
        },
        "realTimeScanDirection": {
            "type": "string",
            "defaultValue": "Both"
        },
        "remediationScheduleDay": {
            "type": "string",
            "defaultValue": "Everyday"
        },
        "scanScheduleDay": {
            "type": "string",
            "defaultValue": "Everyday"
        },
        "disableRealtimeMonitoring": {
            "type": "bool",
            "defaultValue": false
        },
        "environmentPrefix": {
            "type": "string",
            "metadata": {
                "description": "Prefix for environement (production or staging). You can change the allowed values based on your preference."
            },
            "maxLength": 4,
            "defaultValue": ""
        },
        "numberOfWebInstances": {
            "type": "int",
            "defaultValue": 2,
            "minValue": 2,
            "maxValue": 5
        },
        "useExistingKek": {
            "type": "string",
            "defaultValue": "kek",
            "allowedValues": [
                "nokek",
                "kek"
            ],
            "metadata": {
                "description": "Select kek if the secret should be encrypted with a key encryption key and pass explicit keyEncryptionKeyURL. For nokek, you can keep keyEncryptionKeyURL empty."
            }
        },
        "encryptionEnabled": {
            "type": "bool",
            "defaultValue": true
        },
        "adVMSize": {
            "type": "string",
            "allowedValues": [
                "Standard_D1_v2",
                "Standard_D2_v2",
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_D5_v2",
                "Standard_D11_v2",
                "Standard_D12_v2",
                "Standard_D13_v2",
                "Standard_D14_v2",
                "Standard_D15_v2",
                "Standard_D1",
                "Standard_D2",
                "Standard_D3",
                "Standard_D4",
                "Standard_D11",
                "Standard_D12",
                "Standard_D13",
                "Standard_D14",
                "Standard_DS1",
                "Standard_DS2",
                "Standard_DS3",
                "Standard_DS4",
                "Standard_DS11",
                "Standard_DS12",
                "Standard_DS13",
                "Standard_DS14",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_DS11_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2",
                "Standard_DS14_v2",
                "Standard_DS15_v2",
                "Standard_GS1",
                "Standard_GS2",
                "Standard_GS3",
                "Standard_GS4",
                "Standard_GS4",
                "Standard_GS5"
            ],
            "metadata": {
                "description": "The size of the AD VMs Created"
            },
            "defaultValue": "Standard_D1_v2"
        },
        "sqlVMSize": {
            "type": "string",
            "allowedValues": [
                "Standard_DS1",
                "Standard_DS2",
                "Standard_D2_v2",
                "Standard_DS3",
                "Standard_DS4",
                "Standard_DS11",
                "Standard_DS12",
                "Standard_DS13",
                "Standard_DS14",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_DS11_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2",
                "Standard_DS14_v2",
                "Standard_DS15_v2",
                "Standard_GS1",
                "Standard_GS2",
                "Standard_GS3",
                "Standard_GS4",
                "Standard_GS4",
                "Standard_GS5"
            ],
            "metadata": {
                "description": "The size of the SQL VMs Created"
            },
            "defaultValue": "Standard_D2_v2"
        },
        "webVMSize": {
            "type": "string",
            "allowedValues": [
                "Standard_DS1",
                "Standard_DS2",
                "Standard_DS3",
                "Standard_DS4",
                "Standard_D2_v2",
                "Standard_DS11",
                "Standard_DS12",
                "Standard_DS13",
                "Standard_DS14",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_DS11_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2",
                "Standard_DS14_v2",
                "Standard_DS15_v2",
                "Standard_GS1",
                "Standard_GS2",
                "Standard_GS3",
                "Standard_GS4",
                "Standard_GS4",
                "Standard_GS5"
            ],
            "metadata": {
                "description": "The size of the SQL VMs Created"
            },
            "defaultValue": "Standard_D2_v2"
        },
        "mgtVMSize": {
            "type": "string",
            "allowedValues": [
                "Standard_DS1",
                "Standard_D1_v2",
                "Standard_DS2",
                "Standard_DS3",
                "Standard_DS4",
                "Standard_DS11",
                "Standard_DS12",
                "Standard_DS13",
                "Standard_DS14",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_DS11_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2",
                "Standard_DS14_v2",
                "Standard_DS15_v2",
                "Standard_GS1",
                "Standard_GS2",
                "Standard_GS3",
                "Standard_GS4",
                "Standard_GS4",
                "Standard_GS5"
            ],
            "metadata": {
                "description": "The size of the SQL VMs Created"
            },
            "defaultValue": "Standard_D1_v2"
        },
        "witnessVMSize": {
            "type": "string",
            "allowedValues": [
                "Standard_DS1",
                "Standard_DS2",
                "Standard_D1_v2",
                "Standard_DS3",
                "Standard_DS4",
                "Standard_DS11",
                "Standard_DS12",
                "Standard_DS13",
                "Standard_DS14",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_DS11_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2",
                "Standard_DS14_v2",
                "Standard_DS15_v2",
                "Standard_GS1",
                "Standard_GS2",
                "Standard_GS3",
                "Standard_GS4",
                "Standard_GS4",
                "Standard_GS5"
            ],
            "metadata": {
                "description": "The size of the Witness VM Created"
            },
            "defaultValue": "Standard_D1_v2"
        },
        "domainName": {
            "type": "string",
            "metadata": {
                "description": "The FQDN of the AD Domain created "
            },
            "defaultValue": "contoso.local"
        },
        "sqlServerServiceAccountUserName": {
            "type": "string",
            "metadata": {
                "description": "The SQL Server Service Account name"
            },
            "defaultValue": "sqlservice"
        },
        "sqlStorageAccountType": {
            "type": "string",
            "allowedValues": [
                "Premium_LRS",
                "Standard_LRS",
                "Standard_GRS"
            ],
            "metadata": {
                "description": "The type of the Sql Server Storage Account created"
            },
            "defaultValue": "Standard_GRS"
        },
        "dcStorageAccountType": {
            "type": "string",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "The type of the DC Storage Account created"
            },
            "defaultValue": "Standard_GRS"
        },
        "webStorageAccountType": {
            "type": "string",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "The type of the DC Storage Account created"
            },
            "defaultValue": "Standard_GRS"
        },
        "mgtStorageAccountType": {
            "type": "string",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "The type of the DC Storage Account created"
            },
            "defaultValue": "Standard_GRS"
        },
        "virtualNetworkAddressRange": {
            "type": "string",
            "metadata": {
                "description": "The address range of the new VNET in CIDR format"
            },
            "defaultValue": "10.200.0.0/16"
        },
        "sqlSubnet": {
            "type": "object",
            "metadata": {
                "description": "The address range of the subnet static IPs are allocated from in the new VNET"
            },
            "defaultValue": {
                "name": "sql",
                "properties": {
                    "addressPrefix": "10.200.1.0/24"
                }
            }
        },
        "appGatewaySubnet": {
            "type": "object",
            "metadata": {
                "description": "The address range of the subnet static IPs are allocated from in the new VNET"
            },
            "defaultValue": {
                "name": "appgateway",
                "properties": {
                    "addressPrefix": "10.200.4.0/24"
                }
            }
        },
        "webSubnet": {
            "type": "object",
            "metadata": {
                "description": "The address range of the SQL subnet created in the new VNET"
            },
            "defaultValue": {
                "name": "web",
                "properties": {
                    "addressPrefix": "10.200.2.0/24"
                }
            }
        },
        "dcSubnet": {
            "type": "object",
            "metadata": {
                "description": "The address range of the SQL subnet created in the new VNET"
            },
            "defaultValue": {
                "name": "dc",
                "properties": {
                    "addressPrefix": "10.200.0.0/24"
                }
            }
        },
        "mgtSubnet": {
            "type": "object",
            "metadata": {
                "description": "The address range of the SQL subnet created in the new VNET"
            },
            "defaultValue": {
                "name": "mgt",
                "properties": {
                    "addressPrefix": "10.200.3.0/24"
                }
            }
        },
        "sqlLBIPAddress": {
            "type": "string",
            "metadata": {
                "description": "The IP address of the new SQL Server Internal Load Balancer"
            },
            "defaultValue": "10.200.1.5"
        },
        "sql0IPAddress": {
            "type": "string",
            "defaultValue": "10.200.1.6"
        },
        "sql1IPAddress": {
            "type": "string",
            "defaultValue": "10.200.1.7"
        },
        "sqlwIPAddress": {
            "type": "string",
            "defaultValue": "10.200.1.8"
        },
        "adPDCNICIPAddress": {
            "type": "string",
            "metadata": {
                "description": "The IP address of the new AD VM"
            },
            "defaultValue": "10.200.0.5"
        },
        "adBDCNICIPAddress": {
            "type": "string",
            "metadata": {
                "description": "The IP address of the new backup AD VM"
            },
            "defaultValue": "10.200.0.6"
        },
        "webIPAddresses": {
            "type": "array",
            "metadata": {
                "description": "The IP address of the new backup AD VM"
            },
            "defaultValue": [
                { "IpAddress": "10.200.2.5" },
                { "IpAddress": "10.200.2.6" }
            ]
        },
        "mgtIPAddress": {
            "type": "string",
            "metadata": {
                "description": "The IP address of the new backup AD VM"
            },
            "defaultValue": "10.200.3.5"
        },
        "deploymentPrefix": {
            "type": "string",
            "metadata": {
                "description": "The DNS Prefix for the Public IP Address for the Always On Cluster"
            },
            "defaultValue": "aodns"
        },
        "virtualNetworkName": {
            "type": "string",
            "metadata": {
                "description": "Name of virtual network to be created"
            },
            "defaultValue": "autohav2VNET"
        },
        "templatesBaseUrl": {
            "type": "string",
            "metadata": {
                "description": "Linked Templates base url"
            },
            "defaultValue": "https://raw.githubusercontent.com/davoodharun/azure-blueprint/sqlconfig/nestedtemplates"
        },
        "dscBaseUrl": {
            "type": "string",
            "metadata": {
                "description": "DSC Scripts base url"
            },
            "defaultValue": "https://raw.githubusercontent.com/davoodharun/azure-blueprint/sqlconfig/DSC"
        },
        "scriptsBaseUrl": {
            "type": "string",
            "metadata": {
                "description": "DSC Scripts base url"
            },

            "defaultValue": "https://raw.githubusercontent.com/davoodharun/azure-blueprint/sqlconfig/postdeploy"
        },
        "sqlServerVersion": {
            "type": "string",
            "allowedValues": [

                "SQL2012SP3-WS2012R2",
                "SQL2014SP1-WS2012R2",
                "SQL2014SP2-WS2012R2",
                "SQL2016-WS2012R2"
            ],
            "metadata": {
                "description": "The Sql Server Version"
            },
            "defaultValue": "SQL2014SP2-WS2012R2"
        },
        "numberOfSqlVMDisks": {
            "type": "string",
            "allowedValues": [
                "1",
                "2",
                "3",
                "4"
            ],
            "metadata": {
                "description": "The Sql VM Disk Size"
            },
            "defaultValue": "2"
        },
        "gatewaySkuName": {
            "type": "string",
            "defaultValue": "WAF_Medium",
            "allowedValues": [
                "Standard_Small",
                "WAF_Medium",
                "WAF_Large"
            ]
        }
    },
    "variables": {
        "appID": "aadClientID",
        "appSecret": "aadClientSecret",
        "lbSettings": {
            "rdpLBFEName": "rdpLBFE",
            "sqlLBFEName": "sqlLBFE",
            "adLBBEName": "adLBBE",
            "sqlLBBEName": "sqlLBBE",
            "rdpLBName": "rdpLoadBalancer",
            "sqlLBName": "sqlLoadBalancer"
        },
        "wafSettings": {
            "wafMode": "Prevention",
            "wafRuleSetType": "OWASP",
            "wafRuleSetVersion": "3.0",
            "wafEnabled": true
        },
        "numberOfWebInstances": "[length(parameters('webIPAddresses'))]",
        "staticIPWEBStart": 5,
        "RDPNAT": "RDP",
        "SQLAOProbe": "SQLAlwaysOnEndPointProbe",
        "vmSettings": {
            "dc": {
                "imagePublisher": "MicrosoftWindowsServer",
                "imageOffer": "WindowsServer",
                "imageSKU": "2016-Datacenter"
            },
            "sql": {
                "imagePublisher": "MicrosoftSQLServer",
                "imageOffer": "[parameters('sqlServerVersion')]",
                "imageSKU": "Enterprise",
                "autoPatchingEnable": true,
                "autoPatchingDay": "Sunday",
                "autoPatchingStartHour": "2",
                "sqlAOListenerPort": "1433",
                "sqlAOAGName": "alwayson-ag",
                "workloadType": "GENERAL",
                "sqlAOListenerName": "alwayson-ag-listener",
                "sqlAOEPName": "[concat(parameters('deploymentPrefix'),'-hadr')]",
                "sharePath": "[concat(parameters('deploymentPrefix'),'-fsw')]",
                "clusterName": "[concat(parameters('deploymentPrefix'),'-fc')]",
                "sqlAutobackupRetentionPeriod": "2"
            },
            "sqlw": {
                "imagePublisher": "MicrosoftWindowsServer",
                "imageOffer": "WindowsServer",
                "imageSKU": "2016-Datacenter"
            },
            "web": {
                "imagePublisher": "MicrosoftWindowsServer",
                "imageOffer": "WindowsServer",
                "imageSKU": "2016-Datacenter",
                "numberOfWebInstances": "[length(parameters('webIPAddresses'))]",
                "staticIPWEBStart": 5
            },
            "mgt": {
                "imagePublisher": "MicrosoftWindowsServer",
                "imageOffer": "WindowsServer",
                "imageSKU": "2016-Datacenter"
            },
            "vmContainerName": "vhds"
        },
        "VnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkNameWithSuffix'))]",
        "derivedIds": {
            "keyVaultUrl": "[concat('https://', parameters('keyVaultName') ,'.vault.usgovcloudapi.net/')]",
            "keyVaultId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('keyVaultResourceGroupName'), '/providers/Microsoft.KeyVault/vaults/', parameters('keyVaultName'))]",
            "dcSubnet": "[concat(variables('VnetID'),'/subnets/', parameters('dcSubnet').name)]",
            "sqlSubnet": "[concat(variables('VnetID'),'/subnets/', parameters('sqlSubnet').name)]",
            "webSubnet": "[concat(variables('VnetID'),'/subnets/', parameters('webSubnet').name)]",
            "mgtSubnet": "[concat(variables('VnetID'),'/subnets/', parameters('mgtSubnet').name)]",
            "dcNSG": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('resourceNames').nsgs.dc)]",
            "sqlNSG": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('resourceNames').nsgs.sql)]",
            "webNSG": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('resourceNames').nsgs.web)]",
            "lbNSG": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('resourceNames').nsgs.lb)]",
            "mgtNSG": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('resourceNames').nsgs.mgt)]",
            "adIPConfigID": "[concat(resourceId('Microsoft.Network/networkInterfaces',variables('resourceNames').nics.adpdc),'/ipConfigurations/ipconfig1')]",
            "rdplbFEConfigID": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').rdpLBName),'/frontendIPConfigurations/',variables('lbSettings').rdpLBFEName)]",
            "adRDPNATRuleID": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').rdpLBName),'/inboundNatRules/',variables('RDPNAT'))]",
            "adBEAddressPoolID": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').rdpLBName),'/backendAddressPools/',variables('lbSettings').adLBBEName)]",
            "sqlBEAddressPoolID": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').sqlLBName),'/backendAddressPools/',variables('lbSettings').sqlLBBEName)]",
            "sqllbFEConfigID": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').sqlLBName),'/frontendIPConfigurations/',variables('lbSettings').sqlLBFEName)]",
            "sqllbProbeID": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('lbSettings').sqlLBName),'/probes/',variables('SQLAOProbe'))]"
        },
        "subnets": [
            "[parameters('sqlSubnet')]",
            "[parameters('dcSubnet')]",
            "[parameters('webSubnet')]",
            "[parameters('mgtSubnet')]",
            "[parameters('appGatewaySubnet')]"
        ],
        "virtualNetworkNameWithSuffix": "[concat(parameters('virtualNetworkName'), uniqueString(resourceGroup().id))]",
        "resourceNames": {
            "virtualNetworkNameWithSuffix": "[concat(parameters('virtualNetworkName'), uniqueString(resourceGroup().id))]",
            "nsgs": {
                "mgt": "[concat('MGTNSG', parameters('environmentPrefix'))]",
                "dc": "[concat('DCNSG', parameters('environmentPrefix'))]",
                "web": "[concat('WEBNSG', parameters('environmentPrefix'))]",
                "sql": "[concat('SQLNSG', parameters('environmentPrefix'))]",
                "lb": "[concat('LBNSG', parameters('environmentPrefix'))]"
            },
            "storageAccounts": {
                "sql": "[concat(uniqueString(resourceGroup().id), 'sql', parameters('environmentPrefix'))]",
                "dc": "[concat(uniqueString(resourceGroup().id), 'dc', parameters('environmentPrefix'))]",
                "web": "[concat(uniqueString(resourceGroup().id), 'web', parameters('environmentPrefix'))]",
                "mgt": "[concat(uniqueString(resourceGroup().id), 'mgt', parameters('environmentPrefix'))]"
            },
            "vms": {
                "adpdc": "[concat('AZ-PDC-VM', parameters('environmentPrefix'))]",
                "adbdc": "[concat('AZ-BDC-VM', parameters('environmentPrefix'))]",
                "sql": "[concat(parameters('environmentPrefix'), 'sqlserver-')]",
                "sqlw": "[concat('cluster-fsw', parameters('environmentPrefix'))]",
                "web": "[concat('AZ-WEB-VM', parameters('environmentPrefix'))]",
                "mgt": "[concat('AZ-MGT-VM', parameters('environmentPrefix'))]"
            },
            "nics": {
                "adpdc": "[concat('adPDC-nic', parameters('environmentPrefix'))]",
                "adbdc": "[concat('adBDC-nic', parameters('environmentPrefix'))]",
                "sqlw": "[concat('sqlw-nic', parameters('environmentPrefix'))]",
                "sql0": "[concat('sql0-nic', parameters('environmentPrefix'))]",
                "sql1": "[concat('sql1-nic', parameters('environmentPrefix'))]",
                "web": "[concat('WEB-nic', parameters('environmentPrefix'))]",
                "mgt": "[concat('MGT-nic', parameters('environmentPrefix'))]"
            },
            "loadBalancers": {
                "rdpLBFEName": "rdpLBFE",
                "sqlLBFEName": "sqlLBFE",
                "adLBBEName": "adLBBE",
                "sqlLBBEName": "sqlLBBE",
                "rdpLBName": "rdpLoadBalancer",
                "sqlLBName": "sqlLoadBalancer"
            },
            "availabilitySets": {
                "sql": "[concat('sqlAvailabilitySet', parameters('environmentPrefix'))]",
                "ad": "[concat('adAvailabilitySet', parameters('environmentPrefix'))]",
                "web": "[concat('webAvailabilitySet', parameters('environmentPrefix'))]"
            },
            "publicIPs": {
                "mgt": "mgtpublicip"
            }
        },
        "artifacts": {
            "postDeployScriptUris": [
                "[concat(parameters('scriptsBaseUrl'),'/setPasswordPolicy.ps1')]",
                "[concat(parameters('scriptsBaseUrl'),'/provisioningHybridworkers.ps1')]",
                "[concat(parameters('scriptsBaseUrl'),'/settimezonelogsize.ps1')]"
            ],
            "provisioningHybridworkerUrl": "[concat(parameters('scriptsBaseUrl'),'/provisioningHybridworkers.ps1')]",
            "customScriptBaselineUrl": "[concat(parameters('scriptsBaseUrl'),'/customScriptBaseline.ps1')]",
            "provisioningCustomScriptExtensionUrl": "[concat(parameters('templatesBaseUrl'),'/customScriptExtension.json')]",
            "provisioningOMSWorkspaceUrl": "[concat(parameters('templatesBaseUrl'),'/provisioningAutoAccOMSWorkspace.json')]",
            "provisioningOMSAutomationScheduleUrl": "[concat(parameters('templatesBaseUrl'),'/provisioningAutomationSchedule.json')]",
            "vnetwithDNSTemplateURL": "[concat(parameters('templatesBaseUrl'),'/updateVnetWithDNS.json')]",
            "nicTemplateURL": "[concat(parameters('templatesBaseUrl'),'/updateNic.json')]",
            "sqlLoadBalancerURL": "[concat(parameters('templatesBaseUrl'),'/sqlLoadBalancer.json')]",
            "applicationGatewayURL": "[concat(parameters('templatesBaseUrl'),'/provisioningApplicationGateway.json')]",
            "provisioningNICsSQLADURL": "[concat(parameters('templatesBaseUrl'),'/provisioningNICsSQLAD.json')]",
            "virtualNetworkNSGURL": "[concat(parameters('templatesBaseUrl'),'/virtualNetworkNSG.json')]",
            "provisioningVMsSQLADURL": "[concat(parameters('templatesBaseUrl'),'/provisioningVMsSQLAD.json')]",
            "provisioningAppVMsURL": "[concat(parameters('templatesBaseUrl'),'/provisioningAppVMs.json')]",
            "provisioningRCV": "[concat(parameters('templatesBaseUrl'),'/recoveryServicesVault.json')]",
            "backupVMProtectedItem": "[concat(parameters('templatesBaseUrl'),'/backupProtectedItems.json')]",
            "backupPolicy": "[concat(parameters('templatesBaseUrl'),'/recoveryServicesBackupPolicy.json')]",
            "configuringBackupADVMURL": "[concat(parameters('templatesBaseUrl'),'/configuringBackupADVM.json')]",
            "preparingAlwaysOnSqlServerURL": "[concat(parameters('templatesBaseUrl'),'/preparingSqlServer.json')]",
            "configuringAlwaysOnURL": "[concat(parameters('templatesBaseUrl'),'/configuringAlwaysOn.json')]",
            "preparingAlwaysOnSqlServerURLAObypass": "[concat(parameters('templatesBaseUrl'),'/preparingSqlServerAObypass.json')]",
            "configuringAlwaysOnURLAObypass": "[concat(parameters('templatesBaseUrl'),'/configuringAlwaysOnAObypass.json')]",
            "provisioningOMSMonitoringUrl": "[concat(parameters('templatesBaseUrl'), '/provisioningOMSMonitoring.json') ]",
            "pdcModulesURL": "[concat(parameters('dscBaseUrl'),'/PDCBaselineDSC.ps1.zip')]",
            "pdcConfigurationFunction": "PDCBaselineDSC.ps1\\PDCBaselineDSC",
            "bdcModulesURL": "[concat(parameters('dscBaseUrl'),'/BDCBaselineDSC.ps1.zip')]",
            "bdcConfigurationFunction": "BDCBaselineDSC.ps1\\BDCBaselineDSC",
            "sqlwModulesURL": "[concat(parameters('dscBaseUrl'),'/SQLWBaselineDSC.ps1.zip')]",
            "sqlwConfigurationFunction": "SQLWBaselineDSC.ps1\\SQLWBaselineDSC",
            "sql0ModulesURL": "[concat(parameters('dscBaseUrl'),'/SQL0BaselineDSC.ps1.zip')]",
            "sql0ConfigurationFunction": "SQL0BaselineDSC.ps1\\SQL0BaselineDSC",
            "sql1ModulesURL": "[concat(parameters('dscBaseUrl'),'/SQL1BaselineDSC.ps1.zip')]",
            "sql1ConfigurationFunction": "SQL1BaselineDSC.ps1\\SQL1BaselineDSC",
            "webModulesURL": "[concat(parameters('dscBaseUrl'),'/WEBBaselineDSC.ps1.zip')]",
            "webConfigurationFunction": "WEBBaselineDSC.ps1\\WEBBaselineDSC",
            "mgtModulesURL": "[concat(parameters('dscBaseUrl'),'/MGTBaselineDSC.ps1.zip')]",
            "mgtConfigurationFunction": "MGTBaselineDSC.ps1\\MGTBaselineDSC"
        },
        "prepareAlwaysOnSQLInfo": {
            "artifacts": "[variables('artifacts')]",
            "resourceNames": "[variables('resourceNames')]",
            "derivedIds": "[variables('derivedIds')]",
            "vmSettings": "[variables('vmSettings')]",
            "sqlServerServiceAccountUserName": "[parameters('sqlServerServiceAccountUserName')]",
            "numberOfSqlVMDisks": "[parameters('numberOfSqlVMDisks')]"
        },
        "configuringAlwaysOnInfo": {
            "lbSettings": "[variables('lbSettings')]",
            "sqlLBIPAddress": "[parameters('sqlLBIPAddress')]"
        },
        "backupInfo": {
            "rcVaultName": "[parameters('recoveryServicesVaultName')]",
            "backupPolicy": "[parameters('backupPolicy')]",
            "backupTemplateUrl": "[variables('artifacts').backupVMProtectedItem]",
            "backupPolicyTemplateUrl": "[variables('artifacts').backupPolicy]",
            "backupScheduleRunTimes": "[parameters('backupScheduleRunTimes')]",
            "backupDailyRetentionDurationCount": "[parameters('backupDailyRetentionDurationCount')]",
            "backupDaysOfTheWeek": "[parameters('backupDaysOfTheWeek')]",
            "backupWeeklyRetentionDurationCount": "[parameters('backupWeeklyRetentionDurationCount')]",
            "backupMonthlyRetentionDurationCount": "[parameters('backupMonthlyRetentionDurationCount')]",
            "backupMonthsOfYear": "[parameters('backupMonthsOfYear')]",
            "backupYearlyRetentionDurationCount": "[parameters('backupYearlyRetentionDurationCount')]"
        },
        "vmEncryptionSettings": {
            "sequenceVersion": "1.0",
            "volumeType": "All",
            "diskEncryptionExtensionName": "AzureDiskEncryption",
            "diskEncryptionExtensionVersion": "1.1",
            "encryptionOperation": "EnableEncryption",
            "keyEncryptionAlgorithm": "RSA-OAEP",
            "keyVaultURL": "[concat('https://', parameters('keyVaultName'), '.vault.usgovcloudapi.net/')]",
            "provisioningVMAzureDiskEncryptionUrl": "[concat(parameters('templatesBaseUrl'),'/configuringVMAzureDiskEncryption-', parameters('useExistingKek'),'.json')]",
            "keyVaultId": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('keyVaultResourceGroupName'), '/providers/Microsoft.KeyVault/vaults/', parameters('keyVaultName'))]",
            "keyVaultResourceID": "[concat(subscription().id,'/resourceGroups/',parameters('keyVaultResourceGroupName'),'/providers/Microsoft.KeyVault/vaults/', parameters('keyVaultName'))]"
        },
        "antimalwareInfo": {
            "exclusionPath": {
                "web": "[concat(parameters('exclusionPathWeb'),parameters('exclusionPathGen'))]",
                "sql": "[concat(parameters('exclusionPathSQL'),parameters('exclusionPathGen'))]",
                "sqlWS2012": "[parameters('exclusionPathSQLWS2012')]",
                "ad": "[concat(parameters('exclusionPathAD'),parameters('exclusionPathGen'))]",
                "mgt": "[concat(parameters('exclusionPathMgt'),parameters('exclusionPathGen'))]"
            },
            "exclusionExtension": {
                "web": "[concat(parameters('exclusionExtensionWeb'),parameters('exclusionExtensionGen'))]",
                "sql": "[concat(parameters('exclusionExtensionSQL'),parameters('exclusionExtensionGen'))]",
                "sqlWS2012": "[parameters('exclusionExtensionSQLWS2012')]",
                "ad": "[concat(parameters('exclusionExtensionAD'),parameters('exclusionExtensionGen'))]",
                "mgt": "[concat(parameters('exclusionExtensionMgt'),parameters('exclusionExtensionGen'))]"
            },
            "exclusionProcess": {
                "web": "[concat(parameters('exclusionProcessWeb'),parameters('exclusionProcessGen'))]",
                "sql": "[concat(parameters('exclusionProcessSQL'),parameters('exclusionProcessGen'))]",
                "sqlWS2012": "[parameters('exclusionProcessSQLWS2012')]",
                "ad": "[concat(parameters('exclusionProcessAD'),parameters('exclusionProcessGen'))]",
                "mgt": "[concat(parameters('exclusionProcessMgt'),parameters('exclusionProcessGen'))]"
            },
            "realTimeScanDirection": "[parameters('realTimeScanDirection')]",
            "remediationScheduleDay": "[parameters('remediationScheduleDay')]",
            "scanScheduleDay": "[parameters('scanScheduleDay')]",
            "disableRealtimeMonitoring": "[parameters('disableRealtimeMonitoring')]"
        },
        "vmNames": {
            "VMs": [{
                    "Name": "[variables('resourceNames').vms.adpdc]"
                },
                {
                    "Name": "[variables('resourceNames').vms.adbdc]"
                },
                {
                    "Name": "[variables('resourceNames').vms.mgt]"
                },
                {
                    "Name": "[variables('resourceNames').vms.sqlw]"
                },
                {
                    "Name": "[concat(variables('resourceNames').vms.sql,'0')]"
                },
                {
                    "Name": "[concat(variables('resourceNames').vms.sql,'1')]"
                }
            ]
        }
    },
    "resources": [{
            "name": "CreateAutomationAccountAndOMSWorkspace",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningOMSWorkspaceUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "omsWorkspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    },
                    "omsWorkspaceRegion": {
                        "value": "[parameters('omsWorkspaceRegion')]"
                    },
                    "serviceTier": {
                        "value": "[parameters('serviceTier')]"
                    },
                    "dataRetention": {
                        "value": "[parameters('dataRetention')]"
                    },
                    "omsAutomationAccountName": {
                        "value": "[parameters('omsAutomationAccountName')]"
                    },
                    "artifactsLocation": {
                        "value": "[parameters('scriptsBaseUrl')]"
                    }
                }
            }
        },
        {
            "name": "RecoverServicesVault",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningRCV]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "backupInfo": {
                        "value": "[variables('backupInfo')]"
                    }
                }
            }
        },
        {
            "name": "BackupPolicyCustom",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/RecoverServicesVault"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').backupPolicy]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "backupInfo": {
                        "value": "[variables('backupInfo')]"
                    }
                }
            }
        },
        {
            "name": "VirtualNetworkNSG",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "comments": "This resource will create storage accounts for Active Directory, SQL Server, File Share Witness and Diagnostics. It will also create the Virtual Network and public IP addresses",
            "dependsOn": [
                "Microsoft.Resources/deployments/CreateAutomationAccountAndOMSWorkspace"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').virtualNetworkNSGURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[resourceGroup().location]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkNameWithSuffix')]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "subnets": {
                        "value": "[variables('subnets')]"
                    },
                    "dcNSGName": {
                        "value": "[variables('resourceNames').nsgs.dc]"
                    },
                    "sqlNSGName": {
                        "value": "[variables('resourceNames').nsgs.sql]"
                    },
                    "webNSGName": {
                        "value": "[variables('resourceNames').nsgs.web]"
                    },
                    "mgtNSGName": {
                        "value": "[variables('resourceNames').nsgs.mgt]"
                    },
                    "lbNSGName": {
                        "value": "[variables('resourceNames').nsgs.lb]"
                    },
                    "appGatewayAddressRange": {
                        "value": "[parameters('appGatewaySubnet').properties.addressPrefix]"
                    }
                }
            }
        },
        {
            "name": "SQLLoadBalancer",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "comments": "Create Load Balancers for SQL and DC",
            "dependsOn": [
                "Microsoft.Resources/deployments/VirtualNetworkNSG"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').sqlLoadBalancerURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[resourceGroup().location]"
                    },
                    "sqlLBName": {
                        "value": "[variables('lbSettings').sqlLBName]"
                    },
                    "sqlLBFEName": {
                        "value": "[variables('lbSettings').sqlLBFEName]"
                    },
                    "sqlLBIPAddress": {
                        "value": "[parameters('sqlLBIPAddress')]"
                    },
                    "sqlSubnetRef": {
                        "value": "[variables('derivedIds').sqlSubnet]"
                    },
                    "sqlLBBEName": {
                        "value": "[variables('lbSettings').sqlLBBEName]"
                    },
                    "sqlLBBEID": {
                        "value": "[variables('derivedIds').sqlBEAddressPoolID]"
                    },
                    "sqllbFEConfigID": {
                        "value": "[variables('derivedIds').sqllbFEConfigID]"
                    },
                    "sqllbProbeID": {
                        "value": "[variables('derivedIds').sqllbProbeID]"
                    },
                    "SQLAOProbe": {
                        "value": "[variables('SQLAOProbe')]"
                    }
                }
            }
        },
        {
            "name": "ProvisioningApplicationGateway",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/VirtualNetworkNSG"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').applicationGatewayURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "addressPrefix": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('resourceNames').virtualNetworkNameWithSuffix]"
                    },
                    "subnetPrefix": {
                        "value": "[parameters('appGatewaySubnet').properties.addressPrefix]"
                    },
                    "skuName": {
                        "value": "[parameters('gatewaySkuName')]"
                    },
                    "capacity": {
                        "value": 2
                    },
                    "backendIpsForPathRuleWEB": {
                        "value": "[parameters('webIPAddresses')]"
                    },
                    "pathMatch1": {
                        "value": "/WEB"
                    },
                    "subnetName": {
                        "value": "[parameters('appGatewaySubnet').name]"
                    },
                    "wafEnabled": {
                        "value": "[variables('wafSettings').wafEnabled]"
                    },
                    "wafMode": {
                        "value": "[variables('wafSettings').wafMode]"
                    },
                    "wafRuleSetType": {
                        "value": "[variables('wafSettings').wafRuleSetType]"
                    },
                    "wafRuleSetVersion": {
                        "value": "[variables('wafSettings').wafRuleSetVersion]"
                    },
                    "certData": {
                      "value":"[parameters('certData')]"
                    },
                    "certPassword": {
                      "value":"[parameters('certPassword')]"
                    },
                }
            }
        },
        {
            "name": "ProvisioningNICsSQLADMGT",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/SQLLoadBalancer"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningNICsSQLADURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "location": {
                        "value": "[resourceGroup().location]"
                    },
                    "adPDCNicName": {
                        "value": "[variables('resourceNames').nics.adpdc]"
                    },
                    "adPDCNICIPAddress": {
                        "value": "[parameters('adPDCNICIPAddress')]"
                    },
                    "sqlSubnetRef": {
                        "value": "[variables('derivedIds').sqlSubnet]"
                    },
                    "dcSubnetRef": {
                        "value": "[variables('derivedIds').dcSubnet]"
                    },

                    "mgtSubnetRef": {
                        "value": "[variables('derivedIds').mgtSubnet]"
                    },
                    "adBEAddressPoolID": {
                        "value": "[variables('derivedIds').adBEAddressPoolID]"
                    },
                    "adRDPNATRuleID": {
                        "value": "[variables('derivedIds').adRDPNATRuleID]"
                    },
                    "adBDCNicName": {
                        "value": "[variables('resourceNames').nics.adbdc]"
                    },
                    "adBDCNICIPAddress": {
                        "value": "[parameters('adBDCNICIPAddress')]"
                    },
                    "sqlBEAddressPoolID": {
                        "value": "[variables('derivedIds').sqlBEAddressPoolID]"
                    },
                    "sqlwNicName": {
                        "value": "[variables('resourceNames').nics.sqlw]"
                    },
                    "sql0NicName": {
                        "value": "[variables('resourceNames').nics.sql0]"
                    },
                    "sql1NicName": {
                        "value": "[variables('resourceNames').nics.sql1]"
                    },
                    "sql0IPAddress": {
                        "value": "[parameters('sql0IPAddress')]"
                    },
                    "sql1IPAddress": {
                        "value": "[parameters('sql1IPAddress')]"
                    },
                    "sqlwIPAddress": {
                        "value": "[parameters('sqlwIPAddress')]"
                    },
                    "sqlNSGid": {
                        "value": "[variables('derivedIds').sqlNSG]"
                    },
                    "dcNSGid": {
                        "value": "[variables('derivedIds').dcNSG]"
                    },
                    "mgtNICName": {
                        "value": "[variables('resourceNames').nics.mgt]"
                    },
                    "mgtIPAddress": {
                        "value": "[parameters('mgtIPAddress')]"
                    },
                    "mgtNSGid": {
                        "value": "[variables('derivedIds').mgtNSG]"
                    },
                    "mgtPublicIPName": {
                        "value": "[variables('resourceNames').publicIPs.mgt]"
                    }
                }
            }
        },
        {
            "name": "ProvisioningVMsSQLADMGT",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/BackupPolicyCustom",
                "Microsoft.Resources/deployments/ProvisioningNICsSQLADMGT"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningVMsSQLADURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "adPDCVMName": {
                        "value": "[variables('resourceNames').vms.adpdc]"
                    },
                    "adAvailabilitySetName": {
                        "value": "[variables('resourceNames').availabilitySets.ad]"
                    },
                    "sqlAvailabilitySetName": {
                        "value": "[variables('resourceNames').availabilitySets.sql]"
                    },
                    "sqlStorageAccountName": {
                        "value": "[variables('resourceNames').storageAccounts.sql]"
                    },
                    "dcStorageAccountName": {
                        "value": "[variables('resourceNames').storageAccounts.dc]"
                    },
                    "SqlStorageAccountType": {
                        "value": "[parameters('sqlStorageAccountType')]"
                    },
                    "DcStorageAccountType": {
                        "value": "[parameters('dcStorageAccountType')]"
                    },
                    "location": {
                        "value": "[resourceGroup().location]"
                    },
                    "adVMSize": {
                        "value": "[parameters('adVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "adminPassword"
                        }
                    },
                    "adImagePublisher": {
                        "value": "[variables('vmSettings').dc.imagePublisher]"
                    },
                    "adImageOffer": {
                        "value": "[variables('vmSettings').dc.imageOffer]"
                    },
                    "adImageSKU": {
                        "value": "[variables('vmSettings').dc.imageSKU]"
                    },
                    "vmContainerName": {
                        "value": "[variables('vmSettings').vmContainerName]"
                    },
                    "adPDCNicName": {
                        "value": "[variables('resourceNames').nics.adpdc]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "pdcConfigurationFunction": {
                        "value": "[variables('artifacts').pdcConfigurationFunction]"
                    },
                    "pdcModulesURL": {
                        "value": "[variables('artifacts').pdcModulesURL]"
                    },
                    "adBDCVMName": {
                        "value": "[variables('resourceNames').vms.adbdc]"
                    },
                    "adBDCNicName": {
                        "value": "[variables('resourceNames').nics.adbdc]"
                    },
                    "sqlVMName": {
                        "value": "[variables('resourceNames').vms.sql]"
                    },
                    "sqlVMSize": {
                        "value": "[parameters('sqlVMSize')]"
                    },
                    "fswImagePublisher": {
                        "value": "[variables('vmSettings').sqlw.imagePublisher]"
                    },
                    "fswImageOffer": {
                        "value": "[variables('vmSettings').sqlw.imageOffer]"
                    },
                    "fswImageSKU": {
                        "value": "[variables('vmSettings').sqlw.imageSKU]"
                    },
                    "sqlImagePublisher": {
                        "value": "[variables('vmSettings').sql.imagePublisher]"
                    },
                    "sqlImageOffer": {
                        "value": "[variables('vmSettings').sql.imageOffer]"
                    },
                    "sqlImageSKU": {
                        "value": "[variables('vmSettings').sql.imageSKU]"
                    },
                    "mgtImagePublisher": {
                        "value": "[variables('vmSettings').mgt.imagePublisher]"
                    },
                    "mgtImageOffer": {
                        "value": "[variables('vmSettings').mgt.imageOffer]"
                    },
                    "mgtImageSKU": {
                        "value": "[variables('vmSettings').mgt.imageSKU]"
                    },
                    "witnessVMSize": {
                        "value": "[parameters('witnessVMSize')]"
                    },
                    "sqlwVMName": {
                        "value": "[variables('resourceNames').vms.sqlw]"
                    },
                    "sqlwNicName": {
                        "value": "[variables('resourceNames').nics.sqlw]"
                    },
                    "sql0NicName": {
                        "value": "[variables('resourceNames').nics.sql0]"
                    },
                    "sql1NicName": {
                        "value": "[variables('resourceNames').nics.sql1]"
                    },
                    "environmentPrefix": {
                        "value": "[parameters('environmentPrefix')]"
                    },
                    "mgtVMName": {
                        "value": "[variables('resourceNames').vms.mgt]"
                    },
                    "mgtStorageAccountName": {
                        "value": "[variables('resourceNames').storageAccounts.mgt]"
                    },
                    "mgtStorageAccountType": {
                        "value": "[parameters('mgtStorageAccountType')]"
                    },
                    "mgtVMSize": {
                        "value": "[parameters('mgtVMSize')]"
                    },
                    "mgtNICName": {
                        "value": "[variables('resourceNames').nics.mgt]"
                    },
                    "mgtIPAddress": {
                        "value": "[parameters('mgtIPAddress')]"
                    },
                    "mgtSubnetRef": {
                        "value": "[variables('derivedIds').mgtSubnet]"
                    },
                    "mgtNSGid": {
                        "value": "[variables('derivedIds').mgtNSG]"
                    },
                    "mgtModulesURL": {
                        "value": "[variables('artifacts').mgtModulesURL]"
                    },
                    "mgtConfigurationFunction": {
                        "value": "[variables('artifacts').mgtConfigurationFunction]"
                    },
                    "updateVnetWithDNSTemplateURL": {
                        "value": "[variables('artifacts').vnetwithDNSTemplateURL]"
                    },
                    "virtualNetworkNameWithSuffix": {
                        "value": "[variables('resourceNames').virtualNetworkNameWithSuffix]"
                    },
                    "virtualNetworkAddressRange": {
                        "value": "[parameters('virtualNetworkAddressRange')]"
                    },
                    "subnets": {
                        "value": "[variables('subnets')]"
                    },
                    "adPDCNICIPAddress": {
                        "value": "[parameters('adPDCNICIPAddress')]"
                    },
                    "adBDCNICIPAddress": {
                        "value": "[parameters('adBDCNICIPAddress')]"
                    },
                    "bdcConfigurationFunction": {
                        "value": "[variables('artifacts').bdcConfigurationFunction]"
                    },
                    "bdcModulesURL": {
                        "value": "[variables('artifacts').bdcModulesURL]"
                    },
                    "configuringBackupADVMURL": {
                        "value": "[variables('artifacts').configuringBackupADVMURL]"
                    },
                    "updateNicTemplateURL": {
                        "value": "[variables('artifacts').nicTemplateURL]"
                    },
                    "sqlBEAddressPoolID": {
                        "value": "[variables('derivedIds').sqlBEAddressPoolID]"
                    },
                    "sqlSubnetRef": {
                        "value": "[variables('derivedIds').sqlSubnet]"
                    },

                    "postDeployScriptUris": {
                        "value": "[variables('artifacts').postDeployScriptUris]"
                    },
                    "prepareAlwaysOnSQLInfo": {
                        "value": "[variables('prepareAlwaysOnSQLInfo')]"
                    },
                    "configuringAlwaysOnInfo": {
                        "value": "[variables('configuringAlwaysOnInfo')]"
                    },
                    "backupInfo": {
                        "value": "[variables('backupInfo')]"
                    },
                    "keyVaultName": {
                        "value": "[parameters('keyVaultName')]"
                    },
                    "vmEncryptionSettings": {
                        "value": "[variables('vmEncryptionSettings')]"
                    },
                    "antimalwareInfo": {
                        "value": "[variables('antimalwareInfo')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    },
                    "AutomationAccountName": {
                        "value": "[parameters('omsAutomationAccountName')]"
                    },
                    "EnvironmentName": {
                        "value": "[parameters('EnvironmentName')]"
                    },
                    "AzureUserName": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azureUserName"
                        }
                    },
                    "AzurePassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azurePassword"
                        }
                    },
                    "SubscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "ResourceGroupName": {
                        "value": "[resourceGroup().name]"
                    },
                    "provisioningHybridworkersUrl": {
                        "value": "[variables('artifacts').provisioningHybridworkerUrl]"
                    },
                    "omsWorkspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    },
                    "configureSQLAO": {
                        "value": "[parameters('configureSQLAO')]"
                    }
                }
            }
        },
        {
            "name": "WebTier",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/ProvisioningVMsSQLADMGT"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningAppVMsURL]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "numberOfWebInstances": {
                        "value": "[variables('numberOfWebInstances')]"
                    },
                    "WebVMName": {
                        "value": "[variables('resourceNames').vms.web]"
                    },
                    "WebAvailabilitySetName": {
                        "value": "[variables('resourceNames').availabilitySets.web]"
                    },
                    "WebStorageAccountName": {
                        "value": "[variables('resourceNames').storageAccounts.web]"
                    },
                    "webStorageAccountType": {
                        "value": "[parameters('webStorageAccountType')]"
                    },
                    "location": {
                        "value": "[resourceGroup().location]"
                    },
                    "WebVMSize": {
                        "value": "[parameters('webVMSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "adminPassword"
                        }
                    },
                    "appImagePublisher": {
                        "value": "[variables('vmSettings').web.imagePublisher]"
                    },
                    "appImageOffer": {
                        "value": "[variables('vmSettings').web.imageOffer]"
                    },
                    "appImageSKU": {
                        "value": "[variables('vmSettings').web.imageSKU]"
                    },
                    "vmContainerName": {
                        "value": "[variables('vmSettings').vmContainerName]"
                    },
                    "WEBNICName": {
                        "value": "[variables('resourceNames').nics.web]"
                    },
                    "subnetRef": {
                        "value": "[variables('derivedIds').webSubnet]"
                    },
                    "webNSGid": {
                        "value": "[variables('derivedIds').webNSG]"
                    },
                    "domainName": {
                        "value": "[parameters('domainName')]"
                    },
                    "webModulesURL": {
                        "value": "[variables('artifacts').webModulesURL]"
                    },
                    "webConfigurationFunction": {
                        "value": "[variables('artifacts').webConfigurationFunction]"
                    },
                    "staticIPWEBStart": {
                        "value": "[variables('staticIPWEBStart')]"
                    },
                    "webSubnetAddressRange": {
                        "value": "[parameters('webSubnet').properties.addressPrefix]"
                    },
                    "backupInfo": {
                        "value": "[variables('backupInfo')]"
                    },
                    "keyVaultName": {
                        "value": "[parameters('keyVaultName')]"
                    },
                    "vmEncryptionSettings": {
                        "value": "[variables('vmEncryptionSettings')]"
                    },
                    "antimalwareInfo": {
                        "value": "[variables('antimalwareInfo')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    },
                    "AutomationAccountName": {
                        "value": "[parameters('omsAutomationAccountName')]"
                    },
                    "EnvironmentName": {
                        "value": "[parameters('EnvironmentName')]"
                    },
                    "AzureUserName": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azureUserName"
                        }
                    },
                    "AzurePassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azurePassword"
                        }
                    },
                    "SubscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "ResourceGroupName": {
                        "value": "[resourceGroup().name]"
                    },
                    "provisioningHybridworkersUrl": {
                        "value": "[variables('artifacts').provisioningHybridworkerUrl]"
                    },
                    "omsWorkspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    }
                }
            }
        },
        {
            "name": "[concat('ConfigurationOMSMonitoringSQLAD-', variables('vmNames').VMs[copyIndex()].Name)]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/WebTier"
            ],
            "copy": {
                "name": "monitorVMLoopSQLAD",
                "count": "[length(variables('vmNames').VMs)]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningOMSMonitoringUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[variables('vmNames').VMs[copyIndex()].Name]"
                    },
                    "workspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    },
                    "AutomationAccountName": {
                        "value": "[parameters('omsAutomationAccountName')]"
                    },
                    "EnvironmentName": {
                        "value": "[parameters('EnvironmentName')]"
                    },
                    "AzureUserName": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azureUserName"
                        }
                    },
                    "AzurePassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azurePassword"
                        }
                    },
                    "SubscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "ResourceGroupName": {
                        "value": "[resourceGroup().name]"
                    },
                    "customScriptBaselineUrl": {
                        "value": "[variables('artifacts').customScriptBaselineUrl]"
                    },
                    "MachinesToSetPasswordPolicy": {
                        "value": "[concat(variables('resourceNames').vms.adpdc,';', variables('resourceNames').vms.adbdc)]"
                    }
                }
            }
        },
        {
            "name": "[concat('ConfigurationOMSMonitoringWEB-', variables('resourceNames').vms.web, copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "Microsoft.Resources/deployments/WebTier"
            ],
            "copy": {
                "name": "monitorVMLoopWEB",
                "count": "[variables('numberOfWebInstances')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningOMSMonitoringUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[concat(variables('resourceNames').vms.web, copyindex())]"
                    },
                    "workspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    },
                    "AutomationAccountName": {
                        "value": "[parameters('omsAutomationAccountName')]"
                    },
                    "EnvironmentName": {
                        "value": "[parameters('EnvironmentName')]"
                    },
                    "AzureUserName": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azureUserName"
                        }
                    },
                    "AzurePassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azurePassword"
                        }
                    },
                    "SubscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "ResourceGroupName": {
                        "value": "[resourceGroup().name]"
                    },
                    "customScriptBaselineUrl": {
                        "value": "[variables('artifacts').customScriptBaselineUrl]"
                    },
                    "MachinesToSetPasswordPolicy": {
                        "value": ""
                    }
                }
            }
        },
        /*{
            "name": "[concat('CustomScriptExtensionWEB-', variables('resourceNames').vms.web, copyindex())]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "monitorVMLoopWEB"
            ],
            "copy": {
                "name": "CustomScriptExtensionLoopWEB",
                "count": "[variables('numberOfWebInstances')]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningcustomScriptExtensionUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[concat(variables('resourceNames').vms.web, copyindex())]"
                    },
                    "workspaceName": {
                        "value": "[parameters('omsWorkspaceName')]"
                    },
                    "AutomationAccountName": {
                        "value": "[parameters('omsAutomationAccountName')]"
                    },
                    "EnvironmentName": {
                        "value": "[parameters('EnvironmentName')]"
                    },
                    "AzureUserName": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azureUserName"
                        }
                    },
                    "AzurePassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[variables('derivedIds').keyVaultId]"
                            },
                            "secretName": "azurePassword"
                        }
                    },
                    "SubscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "ResourceGroupName": {
                        "value": "[resourceGroup().name]"
                    },
                    "postDeployScriptUris": {
                        "value": "[variables('artifacts').postDeployScriptUris]"
                    },
                    "MachinesToSetPasswordPolicy": {
                        "value": ""
                    }
                }
            }
        },*/
        {
            "name": "ConfigurationAutomationSchedules",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "monitorVMLoopSQLAD",
                "monitorVMLoopWEB",
                //"CustomScriptExtensionLoopWEB",
                //"CustomScriptExtensionLoopSQLAD"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('artifacts').provisioningOMSAutomationScheduleUrl]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "omsAutomationAccountName": {
                        "value": "[parameters('omsAutomationAccountName')]"
                    },
                    "scheduleName": {
                        "value": "[parameters('scheduleName')]"
                    },
                    "scheduleJobGuid": {
                        "value": "[parameters('scheduleJobGuid')]"
                    },
                    "computerIdList": {
                        "value": ""
                    }
                }
            }
        }
    ]
}
